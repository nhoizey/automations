name: POSSE to Mastodon
on:
  schedule:
    # At every 7th minute from 1 through 59
    # https://crontab.guru/#1/7_*_*_*_*
    - cron: "1/7 * * * *"
  workflow_dispatch:

jobs:
  toots:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout ðŸ›Žï¸
        uses: actions/checkout@v3

      - name: Set up Node.js âš™ï¸
        uses: actions/setup-node@v3
        with:
          node-version-file: ".nvmrc"
          cache: "npm"

      - name: Install dependencies ðŸ“¦
        run: npm ci

      - name: POSSE to Mastodon ðŸ¦£
        env:
          MASTODON_ACCESS_TOKEN: ${{ secrets.MASTODON_ACCESS_TOKEN }}
          MASTODON_INSTANCE: ${{ secrets.MASTODON_INSTANCE }}
          MASTODON_ID: ${{ secrets.MASTODON_ID }}
          RUNNER_TEMPORARY_DIRECTORY: ${{ runner.temp }}
        id: vars
        run: |
          UPDATED=$(npm run posse-mastodon)
          if [[ -z "$UPDATED" ]]; then
            echo 'Nothing to upgrade' >> $GITHUB_STEP_SUMMARY
          else
            echo 'Cache updated with new toot(s)' >> $GITHUB_STEP_SUMMARY
            echo "$UPDATED" >> $GITHUB_STEP_SUMMARY
          fi
          echo "::set-output name=updated::$UPDATED"

      - name: Commit and create PR ðŸ”€
        if: ${{ steps.vars.outputs.updated != '' }}
        uses: peter-evans/create-pull-request@v3
        with:
          title: "chore(cache): update Mastodon cache file (automated)"
          branch: "mastodon-cache-update-automated"
          commit-message: "chore(cache): update Mastodon cache file (automated)"
          labels: |
            type: dependencies ðŸ”—
            automerge ðŸ¤ž
